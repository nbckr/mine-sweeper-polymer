<link rel="import" href="../bower_components/polymer/polymer.html"/>
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"/>
<link rel="import" href="../bower_components/paper-button/paper-button.html"/>
<link rel="import" href="../bower_components/iron-icons/iron-icons.html"/>
<link rel="import" href="minesweeper-grid.html"/>

<dom-module id="minesweeper-main">

    <style is="custom-style">
        iron-icon {
            margin-right: 5px;
        }

        paper-button.custom {
            --paper-button-ink-color: var(--paper-pink-a200);
            --paper-button-flat-keyboard-focus: {
                background-color: var(--paper-pink-a200);
                color: white !important;
            };
            --paper-button-raised-keyboard-focus: {
                background-color: var(--paper-pink-a200) !important;
                color: white !important;
            };
        }
        paper-button.custom:hover {
            background-color: var(--paper-indigo-100);
        }
        paper-button.indigo {
            background-color: var(--paper-indigo-500);
            color: white;
            --paper-button-raised-keyboard-focus: {
                background-color: var(--paper-pink-a200) !important;
                color: white !important;
            };
        }
    </style>

    <template>

        <iron-ajax
                id="ajaxgetter"
                url="http://localhost:9000/game/json"
                method="GET"
                content-type="application/json"
                handle-as="json"
                last-response="{{gamedata}}"
                on-error="_logError"
        ></iron-ajax>

        <iron-ajax
                id="ajaxposter"
                url="http://localhost:9000/game/json"
                method="POST"
                content-type="application/json"
                handle-as="json"
                on-response="_refreshGameData"
                on-error="_logError"
        ></iron-ajax>

        <paper-button raised class="custom indigo" on-click="_handleNewGame">
            <iron-icon icon="add-circle"></iron-icon> Start new game
        </paper-button>

        <minesweeper-grid gamedata="{{gamedata}}"></minesweeper-grid>

    </template>

    <script>
        Polymer({

            is: 'minesweeper-main',

            ready: function () {
                console.log("main: ready");
                this._refreshGameData();

                this.addEventListener('contextmenu', function () {
                    event.preventDefault();
                });
            },

            listeners: {
                'ajax-post': '_handleAjaxPost',
                'server-response': '_refreshGameData'
            },

            _refreshGameData: function () {
                console.log("main: refresh");
                this.$.ajaxgetter.generateRequest();
            },

            _handleAjaxPost: function (event) {
                console.log('main: ajax post');
                event.stopPropagation();
                this.$.ajaxposter.body = event.detail;
                this.$.ajaxposter.generateRequest();
            },

            _handleNewGame: function () {
                this.fire('ajax-post', {
                    action: 'restart'
                });
                this.fire('game-restart', {node: this.$$('minesweeper-cell')});
            },

            _logError: function (event) {
                console.log('main: ajax error');
            }
        });

    </script>

</dom-module>